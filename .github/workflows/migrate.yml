name: Excel to RDS Migration

on:
  workflow_dispatch:
    inputs:
      confirm_migration:
        description: 'Confirm database migration operation. This will load data into the database.'
        required: true
        type: boolean
        default: false
jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to EC2
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_STG_HOST }} # Assuming STG host is for RDS
          DB_URL: ${{ secrets.DB_URL }} # DB_URL secret now holds the DB host
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem

                    # Validate DB secrets

                    if [ -z "$DB_URL" ] || [ -z "$DB_USERNAME" ] || [ -z "$DB_PASSWORD" ]; then

                      echo "Error: One or more DB secrets (DB_URL, DB_USERNAME, DB_PASSWORD) are not set or are empty. Please configure them in your repository settings."

                      exit 1

                    fi

          

                    # Define project path on EC2

                    PROJECT_PATH="/home/ubuntu/BeyondU-Data"

          

                    # Construct the full DATABASE_URL for MySQL
                    # Assuming default MySQL port 3306 and a database named 'beyondu' (or your application DB) on RDS
                    FULL_DATABASE_URL="mysql+mysqlconnector://${DB_USERNAME}:${DB_PASSWORD}@${DB_URL}:3306/beyondu"

          

                    # SSH to EC2 and run migration script

                    ssh -i key.pem ubuntu@$HOST "

                      # Check if project directory exists, if not clone it

                      if [ ! -d \"$PROJECT_PATH\" ]; then

                        echo \"Cloning repository to $PROJECT_PATH\"

                        git clone https://github.com/${{ github.repository }}.git \"$PROJECT_PATH\"

                      fi

          

                      # Navigate to the project directory

                      cd \"$PROJECT_PATH\"

          

                      # Pull the latest changes and ensure the correct branch is checked out

                      git fetch origin

                      git checkout "${{ github.ref_name }}" # Checkout the branch this workflow is running on

                      git reset --hard "origin/${{ github.ref_name }}" # Force update to the latest remote commit of the current branch

                      git clean -fdx # Clean up untracked files and directories, just in case

          

                      # Debug: Remove .pyc files and inspect src/config.py on EC2

                      find src -name "*.pyc" -delete

                      ls -la src/config.py

                      cat src/config.py

          

                      # Install python3-venv if not already installed (idempotent)

                      sudo apt-get update && sudo apt-get install -y python3-venv

          

                      # Set up python virtual environment and install dependencies

                      python3 -m venv venv

                      source venv/bin/activate

                      pip install -r requirements.txt

          

                      if [ \"${{ github.event.inputs.confirm_migration }}\" != \"true\" ]; then

                        echo \"Database migration not confirmed. Exiting.\"

                        exit 1

                      fi

          

                      # Run the ETL script with DATABASE_URL as environment variable

                      DATABASE_URL=\"$FULL_DATABASE_URL\" python scripts/run_etl.py --input data/raw --latest-only --init-db

                    "

          