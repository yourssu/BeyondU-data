name: Excel to RDS Migration

on:
  workflow_dispatch:
    inputs:
      confirm_migration:
        description: 'Confirm database migration operation. This will load data into the database.'
        required: true
        type: boolean
        default: false

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 and Run Migration
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_STG_HOST }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -e

          # --------------------
          # SSH SETUP
          # --------------------
          HOST="$(echo "$HOST" | tr -d '\r\n ')"
          echo "üîç Using HOST=[$HOST]"

          mkdir -p ~/.ssh
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts || true
          echo "$SSH_KEY" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

          # --------------------
          # VALIDATE SECRETS
          # --------------------
          if [ -z "$DB_URL" ] || [ -z "$DB_USERNAME" ] || [ -z "$DB_PASSWORD" ]; then
            echo "‚ùå DB secrets are missing"
            exit 1
          fi

          PROJECT_PATH="/home/ubuntu/BeyondU-Data"
          FULL_DATABASE_URL="mysql+mysqlconnector://${DB_USERNAME}:${DB_PASSWORD}@${DB_URL}:3306/beyondu"

          # --------------------
          # REMOTE EXECUTION
          # --------------------
          ssh -i ~/.ssh/key.pem ubuntu@"$HOST" << EOF
          set -e

          echo "üöÄ Starting migration on EC2"

          # --------------------
          # PROJECT SETUP
          # --------------------
          if [ ! -d "$PROJECT_PATH" ]; then
            git clone https://github.com/${{ github.repository }}.git "$PROJECT_PATH"
          fi

          cd "$PROJECT_PATH"
          git fetch origin
          git checkout "${{ github.ref_name }}"
          git reset --hard "origin/${{ github.ref_name }}"
          git clean -fdx

          find src -name "*.pyc" -delete

          # --------------------
          # AWS CLI (SAFE INSTALL)
          # --------------------
          if ! command -v aws >/dev/null 2>&1; then
            echo "üì¶ Installing awscli v2"
            sudo apt-get update && sudo apt-get install -y curl unzip
            curl "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o awscliv2.zip
            unzip awscliv2.zip
            sudo ./aws/install
            rm -rf awscliv2.zip aws
          else
            echo "‚úÖ awscli already installed"
          fi

          aws --version

          export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
          export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
          export AWS_DEFAULT_REGION="ap-northeast-2"

          # --------------------
          # S3 DATA SYNC
          # --------------------
          mkdir -p data/raw
          echo "üì• Syncing data from S3"
          aws s3 sync s3://beyondu-data/raw/ data/raw

          ls -la data/raw

          # --------------------
          # PYTHON ENV
          # --------------------
          sudo apt-get update
          sudo apt-get install -y python3-venv

          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # --------------------
          # SAFETY CHECK
          # --------------------
          if [ "${{ github.event.inputs.confirm_migration }}" != "true" ]; then
            echo "‚ö†Ô∏è Migration not confirmed. Exiting."
            exit 1
          fi

          # --------------------
          # RUN ETL
          # --------------------
          echo "üî• Running ETL"
            DATABASE_URL="$FULL_DATABASE_URL" \
            python scripts/run_etl.py --input data/raw --init-db
          echo "‚úÖ Migration completed"
          EOF
