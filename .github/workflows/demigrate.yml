name: Excel to RDS Demigration

on:
  workflow_dispatch:
    inputs:
      confirm_drop_db:
        description: 'Confirm database drop operation. This will delete all ETL-related data.'
        required: true
        type: boolean
        default: false

jobs:
  demigrate:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_STG_HOST }} # Assuming STG host is for RDS
          DB_URL: ${{ secrets.DB_URL }} # DB_URL secret now holds the DB host
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem

          # Validate DB secrets
          if [ -z "$DB_URL" ] || [ -z "$DB_USERNAME" ] || [ -z "$DB_PASSWORD" ]; then
            echo "Error: One or more DB secrets (DB_URL, DB_USERNAME, DB_PASSWORD) are not set or are empty. Please configure them in your repository settings."
            exit 1
          fi

          # Define project path on EC2
          PROJECT_PATH="/home/ubuntu/BeyondU-Data"

                              # Construct the full DATABASE_URL for MySQL

                              # Assuming default MySQL port 3306 and a database named 'beyondu' (or your application DB) on RDS

                              FULL_DATABASE_URL="mysql+mysqlconnector://${DB_USERNAME}:${DB_PASSWORD}@${DB_URL}:3306/beyondu"

          # SSH to EC2 and run demigration script
          ssh -i key.pem ubuntu@$HOST "
            # ... (inside SSH block) ...

            # Run the ETL script with --drop-db to clear all data, passing DATABASE_URL as environment variable
            DATABASE_URL=\"$FULL_DATABASE_URL\" python scripts/run_etl.py --drop-db
          "
