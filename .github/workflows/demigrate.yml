name: Excel to RDS Demigration

on:
  workflow_dispatch:
    inputs:
      confirm_drop_db:
        description: 'Confirm database drop operation. This will delete all ETL-related data.'
        required: true
        type: boolean
        default: false

jobs:
  demigrate:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_STG_HOST }}
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem

          # Validate DB_URL secret
          if [ -z "$DB_URL" ]; then
            echo "Error: DB_URL secret is not set or is empty. Please configure the DB_URL secret in your repository settings."
            exit 1
          fi

          # Define project path on EC2
          PROJECT_PATH="/home/ubuntu/BeyondU-Data"

          # SSH to EC2 and run demigration script
          ssh -i key.pem ubuntu@$HOST "
            # Check if project directory exists, if not clone it
            if [ ! -d \"$PROJECT_PATH\" ]; then
              echo \"Cloning repository to $PROJECT_PATH\"
              git clone https://github.com/${{ github.repository }}.git \"$PROJECT_PATH\"
            fi

            # Navigate to the project directory
            cd \"$PROJECT_PATH\"

            # Pull the latest changes
            git pull

            # Install python3-venv if not already installed (idempotent)
            sudo apt-get update && sudo apt-get install -y python3-venv

            # Set up python virtual environment and install dependencies
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

            if [ \"${{ github.event.inputs.confirm_drop_db }}\" != \"true\" ]; then
              echo \"Database drop not confirmed. Exiting.\"
              exit 1
            fi

            # Run the ETL script with --drop-db to clear all data, passing DATABASE_URL as environment variable
            DATABASE_URL=\"$DB_URL\" python scripts/run_etl.py --drop-db
          "
